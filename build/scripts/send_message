#!/bin/sh

_MESSAGE="$1"
_SERVER="${2:-proxy}"
_POINT="http://$_SERVER:8001/services/message"
_DATA="{\"text\":\"$_MESSAGE\", \"service\":\"$SERVICE\", \"node\":\"$NODE\", \"container\":\"$HOSTNAME\"}"

while true
do
    _STATUS=$(curl -s -o /dev/null -w '%{http_code}' -d "$_DATA" -H "Content-Type: application/json" -X POST $_POINT)
    if [ "$_STATUS" = "200" ]
    then
        break
    else
        echo "Received HTTP status $_STATUS when sending message to $_SERVER. Retrying in 2 seconds..."
        sleep 2
    fi
done

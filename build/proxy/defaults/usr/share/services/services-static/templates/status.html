<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width" />
    <style>
      @font-face {
        font-family: Pompiere;
        src: url('/services-static/fonts/Pompiere-Regular.ttf') format('truetype');
      }

      * {
        box-sizing: border-box;
      }

      body {
        width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        font-family: Pompiere, sans-serif;
        color: #ddd;
        overflow: hidden;
      }

      svg {
        width: 100%;
        height: 100%;
      }

      .node {
        fill: lightgray;
        transition: fill 0.3s ease;
      }

      .link {
        fill: green;
        fill-opacity: 0.07;
        cursor: pointer;
        transition: fill-opacity 0.2s ease;
      }

      .link:hover {
        fill-opacity: 0.15;
      }

      .icon {
        width: 10px;
        height: 10px;
      }

      .circle-text {
        text-anchor: middle;
        font-size: 3px;
        fill: #333;
      }

      .status-text {
        font-size: 2.5px;
        font-style: italic;
        fill: #000;
      }

      .info-text {
        font-style: italic;
        fill: #000;
      }

      #organization {
        font-size: 3px;
      }

      #stack {
        font-size: 2.5px;
      }

      #tag {
        font-size: 2px;
      }

      text {
        font-family: Pompiere;
        font-size: 3px;
        font-style: italic;
        fill: #868e96;
      }
    </style>

    <title>Status</title>
  </head>
  <body>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="5 60 180 70" id="main-svg">
      <defs>
        <filter id="glow">
          <feGaussianBlur stdDeviation="0.3" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Preload images -->
      <image id="preload-disconnect" href="/services-static/img/mascot-disconnect.svg" x="0" y="0" height="0" width="0" />

      <!-- Info section -->
      <g transform="translate(146, 80)">
        <text id="organization" class="info-text"></text>
        <text id="stack" class="info-text" x="0" y="3"></text>
        <text id="tag" class="info-text" x="0" y="5"></text>
      </g>

      <!-- Status message -->
      <g transform="translate(146, 106)">
        <a href="/services/logs" target="_blank">
          <image id="mascot" href="/" class="link" x="6" y="8" height="10" width="10" />
        </a>
        <text class="status-text" id="message_serv"></text>
        <text class="status-text" id="message" x="0" y="3">one moment, please</text>
      </g>

      <!-- Services nodes -->
      <g id="portainer-node" transform="translate(29, 83)">
        <image class="icon" href="/services-static/img/portainer.svg" x="1" y="-12" />
        <circle id="portainer" class="node" r="1.5" filter="url(#glow)" />
        <a id="portainer_link_parent" target="_blank">
          <circle id="portainer_link" class="link" cx="7" cy="-7" r="7"><title>Portainer Console</title></circle>
        </a>
        <text x="3" y="2">portainer</text>
      </g>

      <g id="proxy-node" transform="translate(29, 103)">
        <image class="icon" href="/services-static/img/proxy.svg" x="1" y="-12" />
        <circle id="proxy" class="node" r="1.5" filter="url(#glow)" />
        <a id="proxy_link_parent" target="_blank">
          <circle id="proxy_link" class="link" cx="7" cy="-7" r="7"><title>Proxy Statistics</title></circle>
        </a>
        <text x="4" y="2">proxy</text>
      </g>

      <g id="ca-node" transform="translate(29, 123)">
        <image class="icon" href="/services-static/img/ca.svg" x="2" y="-12" />
        <circle id="ca" class="node" r="1.5" filter="url(#glow)" />
        <a id="ca_link_parent" target="_blank">
          <circle id="ca_link" class="link" cx="7" cy="-7" r="7"><title>Certificate Authority API</title></circle>
        </a>
        <text x="6" y="2">ca</text>
      </g>

      <g id="console-node" transform="translate(56, 83)">
        <image class="icon" href="/services-static/img/console.svg" x="2" y="-12" />
        <circle id="console" class="node" r="1.5" filter="url(#glow)" />
        <text id="nodes_console" class="circle-text" x="0" y="1"></text>
        <a id="console_link_parent" target="_blank">
          <circle id="console_link" class="link" cx="7" cy="-7" r="7"><title>Migasfree Console</title></circle>
        </a>
        <text x="4" y="2">console</text>
      </g>

      <g id="public-node" transform="translate(56, 103)">
        <image class="icon" href="/services-static/img/public.svg" x="2" y="-12" />
        <circle id="public" class="node" r="1.5" filter="url(#glow)" />
        <text id="nodes_public" class="circle-text" x="0" y="1"></text>
        <circle id="public_link" class="link" cx="7" cy="-7" r="7"><title>Public Files</title></circle>
        <text x="4" y="2">public</text>
      </g>

      <g id="pms-node" transform="translate(56, 123)">
        <image class="icon" href="/services-static/img/pms.svg" x="2" y="-12" />
        <circle id="pms" class="node" r="1.5" filter="url(#glow)" />
        <text id="nodes_pms" class="circle-text" x="0" y="1"></text>
        <text x="5" y="2">pms</text>
      </g>

      <g id="beat-node" transform="translate(76, 83)">
        <image class="icon" href="/services-static/img/beat.svg" x="2" y="-12" />
        <circle id="beat" class="node" r="1.5" filter="url(#glow)" />
        <text id="nodes_beat" class="circle-text" x="0" y="1"></text>
        <text x="5" y="2">beat</text>
      </g>

      <g id="core-node" transform="translate(76, 103)">
        <image class="icon" href="/services-static/img/core.svg" x="2" y="-12" />
        <circle id="core" class="node" r="1.5" filter="url(#glow)" />
        <text id="nodes_core" class="circle-text" x="0" y="1"></text>
        <a id="core_link_parent" target="_blank">
          <circle id="core_link" class="link" cx="7" cy="-7" r="7"><title>Migasfree API</title></circle>
        </a>
        <text x="5" y="2">core</text>
      </g>

      <g id="worker-node" transform="translate(76, 123)">
        <image class="icon" href="/services-static/img/worker.svg" x="2" y="-12" />
        <circle id="worker" class="node" r="1.5" filter="url(#glow)" />
        <text id="nodes_worker" class="circle-text" x="0" y="1"></text>
        <a id="worker_console_link_parent" target="_blank">
          <circle id="worker_console_link" class="link" cx="7" cy="-7" r="7"><title>Worker Console</title></circle>
        </a>
        <text x="4" y="2">worker</text>
      </g>

      <g id="database-node" transform="translate(96, 83)">
        <image class="icon" href="/services-static/img/database.svg" x="2" y="-12" />
        <circle id="database" class="node" r="1.5" filter="url(#glow)" />
        <a id="database_console_link_parent" target="_blank">
          <circle id="database_console_link" class="link" cx="7" cy="-7" r="7"><title>Database Console</title></circle>
        </a>
        <text x="3" y="2">database</text>
      </g>

      <g id="datastore-node" transform="translate(96, 103)">
        <image class="icon" href="/services-static/img/datastore.svg" x="2" y="-12" />
        <circle id="datastore" class="node" r="1.5" filter="url(#glow)" />
        <a id="datastore_console_link_parent" target="_blank">
          <circle id="datastore_console_link" class="link" cx="7" cy="-7" r="7"><title>Datastore Console</title></circle>
        </a>
        <text x="3" y="2">datastore</text>
      </g>

      <g id="datashare-node" transform="translate(96, 123)">
        <image class="icon" href="/services-static/img/datashare.svg" x="2" y="-12" />
        <circle id="datashare_console" class="node" r="1.5" filter="url(#glow)" />
        <a id="datashare_console_link_parent" target="_blank">
          <circle id="datashare_console_link" class="link" cx="7" cy="-7" r="7"><title>Datashare Console</title></circle>
        </a>
        <text x="3" y="2">datashare</text>
      </g>

      <g id="certbot-node" transform="translate(116, 83)">
        <image class="icon" href="/services-static/img/certbot.svg" x="2" y="-12" />
        <circle id="certbot" class="node" r="1.5" />
        <text x="4" y="2">certbot</text>
      </g>

      <g id="assistant-node" transform="translate(116, 103)">
        <image class="icon" href="/services-static/img/assistant.svg" x="2" y="-12" />
        <circle id="assistant" class="node" r="1.5" filter="url(#glow)" />
        <a id="assistant_link_parent" target="_blank">
          <circle id="assistant_link" class="link" cx="7" cy="-7" r="7"><title>Assistant</title></circle>
        </a>
        <text x="3" y="2">assistant</text>
      </g>

      <g id="mcp-server-node" transform="translate(116, 123)">
        <image class="icon" href="/services-static/img/mcp-server.svg" x="2" y="-12" />
        <circle id="mcp-server" class="node" r="1.5" filter="url(#glow)" />
        <text x="3" y="2">mcp server</text>
      </g>
    </svg>

    <script>
      (function() {
        'use strict';

        // Configuration
        const CONFIG = {
          sseEndpoint: '/services/stream',
          reconnectDelay: 5000,
          disconnectThreshold: 5000,
          welcomeMessages: ['salut!', 'Hi!', '¡hola!', '¡hola, co!', 'kaixo!', 'ola!', 'Hallo!'],
          services: ['proxy', 'ca', 'certbot', 'console', 'core', 'beat', 'worker', 'public',
                     'database', 'datastore', 'portainer', 'datashare_console', 'assistant', 'mcp-server'],
          consoleServices: ['console', 'portainer', 'proxy', 'ca', 'public', 'core',
                           'database_console', 'datastore_console', 'datashare_console',
                           'worker_console', 'assistant']
        };

        // State
        const state = {
          eventSource: null,
          lastUpdate: Date.now(),
          currentData: null,
          currentServ: ''
        };

        // DOM Cache
        const dom = {
          nodes: {},
          links: {},
          nodeTexts: {},
          mascot: null,
          statusTexts: null,
          message: null,
          messageServ: null,
          organization: null,
          stack: null,
          tag: null
        };

        // Initialize DOM cache
        function cacheDOMElements() {
          dom.mascot = document.getElementById('mascot');
          dom.message = document.getElementById('message');
          dom.messageServ = document.getElementById('message_serv');
          dom.organization = document.getElementById('organization');
          dom.stack = document.getElementById('stack');
          dom.tag = document.getElementById('tag');
          dom.statusTexts = document.querySelectorAll('.status-text');

          CONFIG.services.forEach(service => {
            dom.nodes[service] = document.getElementById(service);
            dom.nodeTexts[service] = document.getElementById(`nodes_${service}`);
          });

          CONFIG.consoleServices.forEach(service => {
            const link = document.getElementById(`${service}_link`);
            if (link) dom.links[service] = link.parentElement || link;
          });

          // Special case for public link
          const publicLink = document.getElementById('public_link');
          if (publicLink) dom.links.public = publicLink;
        }

        // Setup links
        function setupLinks() {
          const host = window.location.host;
          const links = {
            portainer_link: `https://portainer-${host}`,
            proxy_link_parent: `https://${host}/stats`,
            ca_link_parent: `https://${host}/ca/docs`,
            console_link: `https://${host}/`,
            core_link_parent: `https://${host}/docs/`,
            worker_console_link_parent: `https://worker-${host}/tasks`,
            database_console_link_parent: `https://database-${host}`,
            datastore_console_link_parent: `https://datastore-${host}`,
            datashare_console_link_parent: `https://datashare-${host}`,
            assistant_link_parent: `https://assistant-${host}`
          };

          Object.entries(links).forEach(([id, href]) => {
            const el = document.getElementById(id);
            if (el) el.setAttribute('href', href);
          });

          // Public link special handling
          const publicLink = document.getElementById('public_link');
          if (publicLink) {
            publicLink.style.cursor = 'pointer';
            publicLink.addEventListener('click', () => {
              window.open(`https://${host}/pool/`, '_blank');
              window.open(`https://${host}/public/`, '_blank');
            });
          }
        }

        // Update service node
        function updateServiceNode(id, data) {
          const serviceKey = `${data.stack}_${id}`;
          const service = data.services?.[serviceKey];
          if (!service || !dom.nodes[id]) return;

          const node = dom.nodes[id];
          const isDisabled = data.disables?.includes(id);
          const isMissing = service.missing && !service.message;
          const hasMessage = !!service.message;
          const nodes = service.nodes || 0;

          let color = '#a9dfbf'; // green
          if (isDisabled) color = 'lightgray';
          else if (isMissing) color = 'red';
          else if (hasMessage) color = 'orange';

          node.style.fill = color;
          node.style.display = 'block';

          if (dom.nodeTexts[id]) {
            dom.nodeTexts[id].textContent = nodes >= 2 ? nodes : '';
          }
        }

        // Update PMS nodes
        function updatePMSNode(data) {
          const stack = data.stack || '';
          let missing = false, hasMessage = false, totalNodes = 0;

          Object.entries(data.services || {}).forEach(([key, service]) => {
            if (key.startsWith(`${stack}_pms-`)) {
              if (service.missing) missing = true;
              if (service.message) hasMessage = true;
              totalNodes += service.nodes || 0;
            }
          });

          const node = dom.nodes.pms;
          if (!node) return;

          let color = '#a9dfbf';
          if (hasMessage) { missing = false; color = 'orange'; }
          else if (missing) color = 'red';

          node.style.fill = color;
          node.style.display = 'block';

          if (dom.nodeTexts.pms) {
            dom.nodeTexts.pms.textContent = totalNodes >= 2 ? totalNodes : '';
          }
        }

        // Update console link visibility
        function updateConsoleLink(id, data) {
          const serviceKey = `${data.stack}_${id}`;
          const service = data.services?.[serviceKey];
          const link = dom.links[id];

          if (link && service) {
            link.style.display = service.missing ? 'none' : 'block';
          }
        }

        // Update mascot animation
        function updateMascot(isOk, isMissing, hasMessage) {
          const now = Date.now();
          let sprite, prefix;

          if (isOk) {
            sprite = Math.floor((now / 1000) % 2);
            prefix = 'mascot-ok';
            dom.statusTexts.forEach(el => el.style.display = 'none');
          } else if (isMissing) {
            sprite = Math.floor((now / 1000) % 2);
            prefix = 'mascot-starting';
            dom.statusTexts.forEach(el => el.style.display = 'block');
          } else if (hasMessage) {
            sprite = Math.floor((now / 1000) % 3);
            prefix = 'mascot-checking';
            dom.statusTexts.forEach(el => el.style.display = 'block');
          } else {
            // Default state when everything is starting
            sprite = 0;
            prefix = 'mascot-welcome';
            dom.statusTexts.forEach(el => el.style.display = 'block');
          }

          dom.mascot.setAttribute('href', `/services-static/img/${prefix}-${sprite}.svg`);
        }

        // Main UI update
        function updateUI(data) {
          if (!data) return;

          state.currentData = data;
          state.lastUpdate = Date.now();

          // Update all service nodes
          CONFIG.services.forEach(id => updateServiceNode(id, data));
          updatePMSNode(data);

          // Update console links
          CONFIG.consoleServices.forEach(id => updateConsoleLink(id, data));

          // Update info
          dom.organization.textContent = data.organization || '';
          dom.stack.textContent = `stack: ${data.stack || ''}`;
          dom.tag.textContent = `migasfree server: ${data.tag || ''}`;

          // Determine which service to show message from
          let messageServ = data.last_message || '';

          // If no last_message or empty serv, find first service with message/missing
          if (!messageServ) {
            for (const [key, service] of Object.entries(data.services || {})) {
              if (service.message || service.missing) {
                messageServ = key;
                break;
              }
            }
          }

          const service = data.services?.[messageServ];
          const message = service?.message || '';
          const isMissing = service?.missing || false;
          const hasAnyMessage = message !== '';

          dom.message.textContent = message || 'ready';
          dom.messageServ.textContent = messageServ ? messageServ.split('_').slice(1).join('_') : '';

          updateMascot(data.ok, isMissing && !hasAnyMessage, hasAnyMessage);

          // Redirect if ok and not on status page
          if (data.ok && !window.location.pathname.startsWith('/services/status')) {
            window.location.href = window.location.href;
          }
        }

        // SSE Connection
        function initSSE() {
          if (state.eventSource) {
            state.eventSource.close();
          }

          state.eventSource = new EventSource(CONFIG.sseEndpoint);

          state.eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              updateUI(data);
            } catch (error) {
              console.error('SSE parse error:', error);
            }
          };

          state.eventSource.onerror = () => {
            console.warn('SSE connection lost, reconnecting...');
            state.eventSource.close();
            showDisconnected();
            setTimeout(initSSE, CONFIG.reconnectDelay);
          };

          state.eventSource.onopen = () => {
            console.log('SSE connected');
          };
        }

        // Show disconnected state
        function showDisconnected() {
          dom.message.textContent = 'disconnected';
          dom.messageServ.textContent = '';
          dom.mascot.setAttribute('href', '/services-static/img/mascot-disconnect.svg');

          Object.values(dom.nodes).forEach(node => {
            if (node) node.style.display = 'none';
          });

          Object.values(dom.links).forEach(link => {
            if (link) link.style.display = 'none';
          });
        }

        // Check connection status
        function checkConnection() {
          const elapsed = Date.now() - state.lastUpdate;
          if (elapsed > CONFIG.disconnectThreshold) {
            showDisconnected();
          }
        }

        // Show welcome screen
        function showWelcome() {
          const randomMsg = CONFIG.welcomeMessages[Math.floor(Math.random() * CONFIG.welcomeMessages.length)];
          dom.message.textContent = randomMsg;
          dom.mascot.style.display = 'none';
          dom.mascot.setAttribute('href', '/services-static/img/mascot-welcome.svg');

          setTimeout(() => {
            dom.mascot.style.display = 'block';
          }, 100);

          Object.values(dom.nodes).forEach(node => {
            if (node) {
              node.style.fill = 'lightgray';
              node.style.display = 'none';
            }
          });

          Object.values(dom.links).forEach(link => {
            if (link) link.style.display = 'none';
          });
        }

        // Initialize
        function init() {
          cacheDOMElements();
          setupLinks();
          showWelcome();
          initSSE();
          setInterval(checkConnection, 2000);
        }

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
          if (state.eventSource) {
            state.eventSource.close();
          }
        });

        // Start when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
  </body>
</html>

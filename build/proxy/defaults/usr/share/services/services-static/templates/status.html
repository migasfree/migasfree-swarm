<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width" />
    <style>
@font-face {
  font-family: Pompiere;
  src: url('/services-static/fonts/Pompiere-Regular.ttf') format('truetype');
}

.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip .tooltiptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

.link {
  fill: green;
  fill-opacity: 0.07;
  cursor: pointer;
}

.circle-text {
  text-anchor: middle;
  font-size: 3px;
}

body {
  width: 100%;
  margin: 0 auto;
  font-family: Pompiere, sans-serif;
  color: #ddd;
}

.bocadillo {
  font-size: 2.5px;
  font-style: italic;
  color: #000;
  margin: 0;
}

#organization, #stack, #tag {
  display: flex;
  font-style: italic;
  align-items: center;
  font-size: 3px;
  color: #000;
}

#stack {
  font-size: 2.5px;
}

#tag {
  font-size: 2px;
}
    </style>

    <title>Status</title>

    <script src="/services-static/js/jquery-1.11.1.min.js" type="text/javascript"></script>

    <script type="text/javascript">
      function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
      }

      let time = +new Date;
      let circles = "#proxy, #ca, #certbot #console, #core, #beat, #worker, #public, #pms, #database, #datastore, #datashare_console, #portainer, assistant";
      let links = "#proxy_link, #ca_link, #console_link, #public_link, #portainer_link, #database_console_link, #datastore_console_link, #datashare_console_link, #worker_console_link, #assistant_link, #core_link";
      let serv = ""

      $(document).ready(function () {
        setInterval(function () {
          let now = +new Date;
          let retraso = parseInt((now - time) / 1000);

          if (retraso > 1.5) {
            $("#message").text('disconnected');
            $("#message_serv").text('');
            $("#spoon").attr("href", "/services-static/img/spoon-disconnect.svg");
            $(circles).hide(200);
            $(links).hide(200);
          }

          $.ajax({
            url: '/services/message',
            success: function (data) {
              function missing_pms() {
                let _missing = false;
                let _message = false;
                let _service = "";
                let _nodes = 0;
                let _stack = data["stack"];

                for (const [key, value] of Object.entries(data['services'])) {
                  if (key.startsWith(_stack+'_pms-')) {
                    if (data['services'][key]["missing"]) {
                      _missing = true;
                      _service = key; // last service found in data
                    }
                    if (data['services'][key]["message"] != "" ) {
                      _message = true;
                      _service = key; // last service found in data
                    }
                    _nodes += data['services'][key]["nodes"]
                  }
                }
                if (_message) {
                  _missing = false;
                }

                if (_missing) {
                  $("#pms").attr('fill', 'red');
                  $("#pms").show(500);
                } else if (_message) {
                  $("#pms").attr('fill', 'orange');
                  $("#pms").hide(500);
                  $("#pms").show(500);
                } else {
                  $("#pms").attr('fill', '#a9dfbf'); // GREEN
                  $("#pms").show(500);
                }

                if (_nodes < 2) {
                  $("#nodes_pms").text("");
                } else {
                  $("#nodes_pms").text(_nodes);
                }

                return _service;
              }

              function missing_console(id) {
                let services = data["services"];
                let _missing = false;
                _missing = services[`${_stack}_${id}`]["missing"];
                if (_missing) {
                  $(`#${id}_link`).hide(500);
                } else {
                  $(`#${id}_link`).show(500);
                }
              }

              function missing(id) {
                let services = data["services"];
                let _missing = false;
                let _message = "";
                let _nodes = 0;
                let _stack = data["stack"];
                _missing = services[`${_stack}_${id}`]["missing"];
                _message = services[`${_stack}_${id}`]["message"];
                _nodes = services[`${_stack}_${id}`]["nodes"];

                if (data["disables"].includes(id)) {
                  $(`#${id}`).attr('fill', '#dddddd');
                  $(`#${id}`).show(500);
                } else {
                  if (_missing) {
                    $(`#${id}`).attr('fill', 'red');
                    $(`#${id}`).show(500);
                    services[`${_stack}_${id}`]["message"]='missing';
                  } else if (_message != "") {
                    $(`#${id}`).attr('fill', 'orange');
                    $(`#${id}`).hide(500);
                    $(`#${id}`).show(500);
                  } else {
                    $(`#${id}`).attr('fill', '#a9dfbf'); // GREEN
                    $(`#${id}`).show(500);
                  }
                }

                if (_nodes < 2) {
                  $(`#nodes_${id}`).text("");
                } else {
                  $(`#nodes_${id}`).text(_nodes);
                }
              }

              time = +new Date;
              let _stack = data["stack"];
              missing("proxy");
              missing("ca");
              missing("certbot");
              missing("console");
              missing("core");
              missing("beat");
              missing("worker");
              missing("public");
              missing("database");
              missing("datastore");
              missing("portainer");
              missing("datashare_console");
              missing("assistant");

              missing_console("console");
              missing_console("portainer");
              missing_console("proxy");
              missing_console("ca");
              missing_console("public");
              missing_console("core");
              missing_console("database_console");
              missing_console("datastore_console");
              missing_console("datashare_console");
              missing_console("worker_console");
              missing_console("assistant");


              let message_pms = missing_pms();
              let message_from = "";
              let message_serv = `${_stack}_${serv}`;

              if (serv == "") {
                message_serv = data['last_message'];
              } else if (serv == "datashare_console") {
                message_serv = `${_stack}_${serv}`;
              }

              if (typeof(data) != "undefined") {
                if (serv == "pms" && message_pms != "") {
                  message = data['services'][message_pms]['message'];
                  message_serv = message_pms;
                  message_from = `${data['services'][message_pms]['container']}@${data['services'][message_pms]['node']}`;
                } else {
                  message = data['services'][message_serv]['message'];
                  message_from = `${data['services'][message_serv]['container']}@${data['services'][message_serv]['node']}`;
                }
              }

              let sprite;
              if (data['ok']) {
                sprite = parseInt((now / 1000) % 2);
                $("#spoon").attr("href", `/services-static/img/spoon-ok-${sprite}.svg`);
                $(".bocadillo").hide(200);

              } else if (message_serv in data['services'] && data['services'][message_serv]['missing']) {
                sprite = parseInt((now / 1000) % 2);
                $("#spoon").attr("href", `/services-static/img/spoon-starting-${sprite}.svg`);
                $(".bocadillo").show(200);
              } else {
                sprite = parseInt((now / 1000) % 3);
                $("#spoon").attr("href", `/services-static/img/spoon-checking-${sprite}.svg`);
                $(".bocadillo").show(200);
              }

              $("#organization").text(data['organization']);
              $("#stack").text('stack: '+ data['stack']);
              $("#tag").text('migasfree server: ' + data['tag']);

              if (message == "") {
                $("#message").text('ready');
              } else {
                $("#message").text(message);
              }

              $("#message_serv").text(message_serv.split('_').slice(1).join('_'));

              $("#message_from").text(message_from);

              if (! location.pathname.startsWith('/services/status')) {
                if (data["ok"]) {
                  $(location).attr('href', location.href);
                }
              }
            },
          });
        }, 1000);
      });

      $(window).load(function () {
        // force download image
        $("#spoon-disconnected").attr('href', '/services-static/img/spoon-disconnect.svg');

        $("#database-svg").attr('href', '/services-static/img/database.svg');

        $(circles).attr('fill', 'orange');
        $(circles).hide(200);
        $(links).hide(200);
        $("#spoon").hide(200);
        $("#spoon").attr('href', '/services-static/img/spoon-welcome.svg');
        $("#spoon").show(100);

        const welcome = ["salut!", "Hi!", "¡hola!", "¡hola, co!", "kaixo!", "ola!", "Hallo!"];
        $("#message").text(welcome[Math.floor(Math.random() * 7)]);

        // tooltips
        $("#proxy_link title").text(
          'proxy statistics:' + String.fromCharCode(10) + 'https://' + location.host + '/stats'
        );
        $("#console_link title").text('migasfree console:' + String.fromCharCode(10) +'https://'+location.host);
        $("#public_link title").text('public files:' + String.fromCharCode(10) +'https://'+location.host+'/pool/');
        $("#core_link title").text('API:' + String.fromCharCode(10) +'https://'+location.host+'/docs/');
        $("#portainer_link title").text(
          'portainer console:' + String.fromCharCode(10) + 'https://portainer-' + location.host
        );
        $("#database_console_link title").text(
          'database console:' + String.fromCharCode(10) + 'https://database-' + location.host
        );
        $("#datastore_console_link title").text(
          'datastore console:' + String.fromCharCode(10) + 'https://datastore-' + location.host
        );
        $("#datashare_console_link title").text(
          'datashare console:' + String.fromCharCode(10) + 'https://datashare-' + location.host
        );
        $("#worker_console_link title").text(
          'worker console:' + String.fromCharCode(10) + 'https://worker-' + location.host + '/tasks'
        );
        $("#assistant_link title").text(
          'assistant:' + String.fromCharCode(10) + 'https://assistant-' + location.host
        );
      });
    </script>
  </head>
  <body>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="5 60 180 70">
      <image href="/services-static/img/background.svg" x=30 y=50 height="100" width="100" />

      <-- force download file spoon-disconnect.svg-->
      <image id="spoon-disconnected" href="/" x=0 y=0 height="0" width="0" />

      <a href="/services/logs" target="_blank">
          <image id="spoon" href="/" class="link" x=155 y=120 height="10" width="10" />
      </a>

      <foreignObject x="145.5" y="107.5" width="38" height="14">
          <p class="bocadillo" id="message_serv">  </p>
          <p class="bocadillo" id="message"> one moment, please </p>
      </foreignObject>

      <foreignObject x="145.5" y="74" width="38" height="8">
          <p id="organization"> </p>
      </foreignObject>

      <foreignObject x="145.5" y="79" width="38" height="6">
          <p id="stack"> </p>
      </foreignObject>

      <foreignObject x="145.5" y="82.5" width="38" height="6">
          <p id="tag"> </p>
      </foreignObject>

      <circle id="proxy" cx="29" cy="107.5" r="1.5" fill="orange "/>
      <circle id="proxy_link" class="link" cx="36" cy="100.5" r="7"
        onclick="window.open('https://' + location.host + '/stats', '_blank');"
      >
        <title> proxy statistics </title>
      </circle>

      <circle id="ca" cx="29" cy="123" r="1.5" fill="orange "/>
      <circle id="ca_link" class="link" cx="36" cy="117" r="7"
        onclick="window.open('https://' + location.host + '/ca/docs', '_blank');"
      >
        <title> Certificate Authority API </title>
      </circle>

      <circle id="certbot" cx="115" cy="89.5" r="1.5" fill="orange "/>

      <circle id="console" cx="64" cy="89.5" r="1.5" fill="orange" />
      <text id="nodes_console" class="circle-text" x="64" y="90.5"></text>
      <circle id="console_link" class="link" cx="70" cy="83" r="7"
        onclick="window.open('https://' + location.host, '_blank');"
      >
        <title> migasfree console </title>
      </circle>

      <circle id="portainer" cx="29" cy="89.5" r="1.5" fill="orange" />
      <circle id="portainer_link" class="link" cx="36" cy="83" r="7"
        onclick="window.open('https://portainer-' + location.host, '_blank');"
      >
        <title> portainer console </title>
      </circle>

      <circle id="core" cx="81" cy="107.5" r="1.5" fill="orange" />
      <text id="nodes_core" class="circle-text" x="81" y="108.5"></text>
      <circle id="core_link" class="link" cx="87.5" cy="100.5" r="7"
        onclick="window.open('https://' + location.host + '/docs/', '_blank');"
      >
        <title> migasfree API </title>
      </circle>

      <circle id="beat" cx="81" cy="89.5" r="1.5" fill="orange" />
      <text id="nodes_beat" class="circle-text" x="81" y="90.5"></text>

      <circle id="worker" cx="81" cy="123" r="1.5" fill="orange" />
      <text id="nodes_worker" class="circle-text" x="81" y="124"></text>
      <circle id="worker_console_link" class="link" cx="87.5" cy="117" r="7"
        onclick="window.open('https://worker-' + location.host + '/tasks', '_blank');"
      >
        <title> worker console </title>
      </circle>

      <circle id="assistant" cx="115" cy="107.5" r="1.5" fill="orange "/>
      <circle id="assistant_link" class="link" cx="123" cy="100.5" r="7"
        onclick="window.open('https://assistant-' + location.host, '_blank');"
      >
        <title> assistant </title>
      </circle>

      <circle id="public" cx="64" cy="107.5" r="1.5" fill="orange" />
      <text id="nodes_public" class="circle-text" x="64" y="108.5"></text>
      <circle id="public_link" class="link" cx="70" cy="100.5" r="7"
        onclick="window.open('https://' + location.host + '/pool/', '_blank'); window.open('https://' + location.host + '/public/', '_blank');"
      >
        <title> public files </title>
      </circle>

      <circle id="pms" cx="64" cy="123" r="1.5" fill="orange" />
      <text id="nodes_pms" class="circle-text" x="64" y="124"></text>
      <circle id="database" cx="98" cy="89.5" r="1.5" fill="orange" />
      <circle id="database_console_link" class="link" cx="105" cy="83" r="7"
        onclick="window.open('https://database-' + location.host, '_blank');"
      >
        <title> database console </title>
      </circle>

      <circle id="datastore" cx="98" cy="107.5" r="1.5" fill="orange" />
      <circle id="datastore_console_link" class="link" cx="105" cy="100.5" r="7"
        onclick="window.open('https://datastore-' + location.host, '_blank');"
      >
        <title> datastore console </title>
      </circle>

      <circle id="datashare_console" cx="98" cy="123" r="1.5" fill="orange" />
      <circle id="datashare_console_link" class="link" cx="105" cy="117" r="7"
        onclick="window.open('https://datashare-' + location.host, '_blank');"
      >
        <title> datashare console </title>
      </circle>
    </svg>
  </body>
</html>
